# TRIGGERS:
#   - Push tag (e.g., 1.0.0 or 1.0.0-preview) â†’ Build, Test, Pack, Publish to NuGet
#
# HOW TO RELEASE:
#   1. git tag 1.0.0
#   2. git push origin 1.0.0
#   3. GitHub Actions automatically builds - MinVer reads version from tag
#
# IMPORTANT:
#   - Tags must be semantic versions (e.g., 1.0.0, 2.1.3, 1.0.0-preview)
#   - fetch-depth: 0 is REQUIRED for MinVer to find tags

name: Build & Release

on:
  push:
    tags:
      - '*'  # Trigger on any tag push

env:
  DOTNET_VERSION: '9.0.x'
  BUILD_CONFIGURATION: 'Release'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true

jobs:
  build:
    name: Build, Test & Pack
    runs-on: windows-latest

    steps:
      # Checkout - MUST have fetch-depth: 0 for MinVer
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for MinVer to find tags

      # Setup .NET SDK
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Verify .NET installation
      - name: Check .NET SDKs and Runtimes
        run: |
          dotnet --list-sdks
          dotnet --version

      # Install MAUI workload
      - name: Install MAUI workloads
        run: |
          dotnet nuget locals all --clear
          dotnet workload install ios maccatalyst maui android --version 9.0.304

      # Restore dependencies
      - name: Restore dependencies
        run: dotnet restore GamaLearn.Maui.sln

      # Build solution
      - name: Build solution
        run: dotnet build GamaLearn.Maui.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      # Run tests (if you have tests in the future)
      # Uncomment when you add test projects
      # - name: Run tests
      #   run: dotnet test GamaLearn.Maui.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal

      # Pack NuGet packages (MinVer sets version automatically from git tag)
      - name: Pack NuGet packages
        run: dotnet pack GamaLearn.Maui.pack.slnf --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --output ./Artifacts

      # Upload artifacts
      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./Artifacts/*.nupkg

      # Publish to NuGet.org
      - name: Publish to NuGet.org
        if: startsWith(github.ref, 'refs/tags/')
        run: dotnet nuget push ./Artifacts/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

      # Create GitHub Release
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ./Artifacts/*.nupkg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
